# 1. 2PC & 3PC
> [二阶段协议](http://ifeve.com/distribute-transaction-2pc/)

```
参与事务提交的过程有两个角色：发起事务的协调者和执行事务的参与者
```
```text
三阶段与二阶段最大不同在于三阶段协议把二阶段的第一阶段拆分为了两个阶段，
其中第一阶段并不锁定资源，而是询问参与者是否可以提交，
等所有参与者回复OK后在具体执行第二阶段锁定资源。理论上如果第一阶段返回都OK，
则第二阶段和三阶段执行成功的概率就很大，另外如果第一阶段有些参与者返回了fail，
由于这时候其他参与者还没有锁定资源，所以不会造成资源的阻塞。
```
> 
# 2.2PC
> 两个阶段：准备阶段 和 提交阶段
## 2.1 准备阶段
 
   - 协调者向所有事务的参与者发送事务内容，询问是否能执行，并等待回复；
   - 参与者 执行事务操作，将Undo和Redo信息记入事务日志中，但不提交事务；
   - 如果参与者执行成功，给协调者反馈YES，如不成功，反馈NO；表示 不可提交；
## 2.2 提交阶段，
### 2.2.1 如果所有参与者都反馈YES的情况下，提交事务

   - 协调者向所有事务参与者发送事务提交请求，commit；
   - 参与者 执行commit请求，并释放资源；
   - 各参与者向协调者反馈ACK
   - 协调者收到所有参与者反馈ACK消息，整个事务执行完成；
### 2.2.2 任何一个参与者反馈NO，中断事务  
   - 协调者向所有参与者发送事务回滚请求，Rollback
   - 参与者根据阶段1中的Undo日志执行回滚，并释放资源；
   - 参与者向协调者反馈ACK完成消息；
   - 协调者收到所有参与者反馈的Ack消息后，即完成事务中断 

## 3.3 2PC 缺点：
   - 同步阻塞：所有参与者处于阻塞状态
   - 协调者单点：只有一个协调者，如果故障，所有参与者处于锁定状态
   - 脑裂，第二阶段，如果有一部分参与者提交成功将导致数据不一致
# 3.3PC
> 三个阶段：canCommit，preCommit，doCommit
## 3.1 canCommit阶段
   - 协调者向所有参与者发送带有事务内容的canCommit请求，询问是否可以提交事务，并等待答复；
   - 各参与者向协调者回馈YES/NO   
## 3.2 preCommit阶段
   - 如果canCommit阶段都返回YES，进行事务预提交；
   - 如果任一参与者反馈NO/或超时没有收到反馈，中断事务；
### 3.2.1 如果canCommit阶段都返回YES，进行事务预提交；
   - 协调者向所有参与者发出PreCommit请求，进入准备阶段。
   - 参与者收到PreCommit请求后，执行事务操作，将Undo和Redo信息记入事务日志中（但不提交事务）。
   - 参与者向协调者回馈ACK/NO响应，等待最终指令
### 3.2.2 如果任一参与者反馈NO/或超时没有收到反馈，中断事务； 
   - 协调者向所有参与者发出abort请求
   - 无论收到协调者发出的abort请求，或者在等待协调者请求过程中出现超时，参与者均会中断事务。 
## 3.3 doCommit阶段
> 此阶段也存在两种情况：
　　1、所有参与者均反馈Ack响应，即执行真正的事务提交。
　　2、任何一个参与者反馈NO，或者等待超时后协调者尚无法收到所有参与者的反馈，即中断事务。
 
### 3.3.1　　提交事务：（所有参与者均反馈Ack响应时）
   - 如果协调者处于工作状态，则向所有参与者发出do Commit请求。
   - 参与者收到do Commit请求后，会正式执行事务提交，并释放整个事务期间占用的资源。
   - 各参与者向协调者反馈Ack完成的消息。
   - 协调者收到所有参与者反馈的Ack消息后，即完成事务提交。
 
### 3.3.2　　中断事务：（任何一个参与者反馈NO，或者等待超时后协调者尚无法收到所有参与者的反馈时）
   - 如果协调者处于工作状态，向所有参与者发出abort请求。
   - 参与者使用阶段1中的Undo信息执行回滚操作，并释放整个事务期间占用的资源。
   - 各参与者向协调者反馈Ack完成的消息。
   - 协调者收到所有参与者反馈的Ack消息后，即完成事务中断。
 
####### 注意：进入阶段三后，无论协调者出现问题，或者协调者与参与者网络出现问题，都会导致参与者无法接收到协调者发出的do Commit请求或abort请求。此时，参与者都会在等待超时之后，继续执行事务提交。

## 3.4 3PC 优缺点
### 3.4.1 优点
```text
降低了阻塞范围，在等待超时后协调者或参与者会中断事务。避免了协调者单点问题，阶段3中协调者出现问题时，参与者会继续提交事务。
```   
### 3.4.2 缺点
```text
缺陷：脑裂问题依然存在，即在参与者收到PreCommit请求后等待最终指令，如果此时协调者无法与参与者正常通信，会导致参与者继续提交事务，造成数据不一致。
```     
        